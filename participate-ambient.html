<html>
    <head>
        <title>participate-ambient</title>
        <script type="text/javascript" src="lib/air/AIRAliases.js">
        </script>
        <script type="text/javascript" src="jquery-1.4.2.min.js">
        </script>
        <script type="text/javascript" src="jquery.spritely-0.2.1.js">
        </script>
		<link type="text/css" href="css/smoothness/jquery-ui-1.8.custom.css" rel="stylesheet" />	
		<script type="text/javascript" src="jquery-ui-1.8.custom.min.js"></script>

        <style type="text/css">
            body {
                height: 100%;
                overflow: hidden;
				font-size: .8em;
            }
            
            #upButton {
                position: absolute;
                left: 900px;
                width: 90px;
                height: 90px;
                background: transparent url(trial_up.png) top right no-repeat;
            }
            
            #bottomBar {
                width: 100%;
                height: 100px;
                margin-left: 50px;
                position: absolute;
                bottom: 0;
            }
        </style>
        <script type="text/javascript">
            $(function(){
				/*
                $('.flower').sprite({
                    fps: 12,
                    no_of_frames: 2
                }).active().activeOnClick();
                */
                
                $('body').data('flowercount', 0);
				$('body').data('studentflowerid', 0);
                $('body').data('flowerType', 0);
				
                $('#upButton').click(function(){
					// We randomised the studentflowerid, by right, should get the student's flower.
					makeFlower(Math.floor(Math.random() * 9),
							   Math.floor(Math.random() * 2),
							   "flower" + $('body').data('flowercount'));
                    $('body').data('flowercount', $('body').data('flowercount') + 1);
				});

				/**
				 * Make a flower appear!
				 * @param {Object} flowerType
				 * 						The colour of the flower/different flowers
				 * @param {Object} flowerSize
				 * 						Size/whatever of flowers based on the rating
				 */
				function makeFlower(flowerType, flowerSize, flowerId) {
					// TODO update the flower when the rating has changed in a nice animation

					// remove the flower if it already exists. This is the way for updating for now
					if ($("#" + flowerId).length) {
						$("#" + flowerId).spStop(true);
						air.trace($._spritely.instances[flowerId]);
						delete $._spritely.instances[flowerId];
						air.trace("deleted" + $._spritely.instances[flowerId]);
						$("#" + flowerId).remove();
					}

					switch(flowerSize){ // larger the number, the better
						case 0:var flowerImage = 'final_flower_test.png'; break;
						case 1:var flowerImage = 'final_flower.png'; break;
					}

					// flower generation
                    $('<div></div>').attr("id", flowerId).css({
                        'background': 'transparent url(flowers.png) 0 0 no-repeat',
                        'bottom': '10px',
                        'left': '100px',
                        'float': 'left',
                        'width': '100px',
                        'height': '100px',
                        'margin-left': -50 + 'px',
                        'margin-top': -40 + 'px'
                    }).data({'flowerType': flowerType, 'flowerSize': flowerSize})
					.appendTo("#bottomBar")
					.sprite({
                        fps: 6,
                        no_of_frames: (flowerSize ? 15 : 5),
                        do_once: true
                    }).spState(flowerType);;
				}
				// Ask for the class
				var askDialog = $('<div id="myDialog"></div>')
				.attr("title", "Please enter the current class")
				.append($('<input type="text" id="classTitle" name="classTitle" placeholder="DEMO Class" />'))
				.dialog({
					resizeable: false,
					// allow dragging of the whole application window
					dragStart: function(event, ui){
						window.nativeWindow.startMove();
					},
					close: function (){if($('body').data('classId') == null) window.nativeWindow.close();},
					buttons: {
						Okay: function(){
							// set it to default if it is blank / actually 0 is default but whatever.
							if($("#classTitle").val() == "") {
								$("#classTitle").val("DEMO Class");
							};
							$.getJSON("http://participate-android.smart.joyent.com/getClassIdFromTitle/",
									$("input", this).serialize(), function(data){
								if (data['ok'] == true) {
									$('body').data('classId', data['classId']);
								}
								else {
									// set it to exactly what the user typed. in case he already typed the id
									$('body').data('classId', $("#classTitle").val());
								}
								// close the dialog box because we got our input

								$("#myDialog").dialog("close");
								// No need any more interaction. So full screen/transparent now.
								window.nativeWindow.alwaysInFront = true;
								window.nativeWindow.stage.displayState = runtime.flash.display.StageDisplayState.FULL_SCREEN;

								(function pollingFunc(){
									// watch out for caching bugs
									// $.getJSON('http://participate-android.smart.joyent.com/pclasspart/' + $('body').data('classId'),
									$.ajax({
										url: 'http://participate-android.smart.joyent.com/pclasspart/' + $('body').data('classId'),
										dataType: 'json',
										cache: false,
										type: 'POST',
										success: function(data){
											air.trace("polling");
											var currentSize;
											var flowerIdSelector;
											for (var i in data) {
												// find out the size of the flower from the rating points
												if (data[i].rating >= 1) { // 1 is our threshold for demo purposes (only 1 rating needed)
													// bigger for better
													currentSize = 1;
												} else {
													currentSize = 0;
												}
												flowerIdSelector = "#" + data[i].id;

												// If the flower isn't there already
												if ($(flowerIdSelector).length == 0) {
													// make the flower!
													makeFlower(Math.floor(Math.random() * 9),
														currentSize, // if more than 5 ratings, big flower
 														data[i].id);
												} else {
													var flower = $(flowerIdSelector);
													// recreate the flower if the size is different
													if(flower.data("flowerSize") != currentSize) {
														makeFlower(flower.data("flowerType"),
															currentSize,
															data[i].id);
													}
												}
											}
										// air.trace(data);
										}
									});
									//start the polling every 8 seconds
									window.setTimeout(pollingFunc, 8000);
								})();
							});
						}
					}
				});
            });
        </script>
    </head>
    <body>
    	<!--
        <div id="upButton">
        </div>
		-->
        <div id="bottomBar">
        </div>
    </body>
</html>
